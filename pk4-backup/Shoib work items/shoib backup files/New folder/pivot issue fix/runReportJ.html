<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "xhtml11.dtd">
<html>
<head>
<title>${runReport.report.name}</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!--  meta http-equiv="X-UA-Compatible" content="chrome=1" -->
<comment>  Leave all this out, for now  </comment>

 	<link rel="stylesheet" type="text/css" href="/atCRM/stylesheets/pivot/bootstrap.min.css"/>

	<link rel="shortcut icon" href="/favicon.ico"/>
	<link rel="stylesheet" type="text/css" href="/atCRM/stylesheets/style_h/ui.core.css"/>
	<link rel="stylesheet" type="text/css" href="/atCRM/stylesheets/style_h/ui.tabs.css"/>
	<link rel="stylesheet" type="text/css" href="/atCRM/stylesheets/style_h/ui.theme.css"/>
	<link rel="stylesheet" type="text/css" href="/atCRM/stylesheets/jquery.dataTables.css"/>
	<link rel="stylesheet" type="text/css" href="/atCRM/stylesheets/pivot/subnav.css"/>
	<link rel="stylesheet" type="text/css" href="/atCRM/stylesheets/pivot/pivot.css"/>
	<link rel="stylesheet" type="text/css" href="/atCRM/stylesheets/TableTools.css"/>
	<link rel="stylesheet" type="text/css" href="/atCRM/stylesheets/TableTools_JUI.css"/>
	<link rel="stylesheet" type="text/css" href="/atCRM/stylesheets/style_h/jquery-ui-1.8.21.custom.css"/>

	<link rel="stylesheet" href="/atCRM/stylesheets/smartSuggest.css">
	<link rel="stylesheet" href="/atCRM/stylesheets/JSON/green/jquery.css"/>
	<link rel="stylesheet" href="/atCRM/stylesheets/JSON/green/main.css"/>
	<link rel="stylesheet" href="/atCRM/stylesheets/entityView.css">
	<link rel="stylesheet" href="/atCRM/stylesheets/JSON/general.css"/>
	<link rel="stylesheet" href="/atCRM/stylesheets/JSON/jquery/jquery.alerts.css"/>    
	<link rel="stylesheet" href="/atCRM/stylesheets/JSON/green/jquery.tabs.css"/>
	<link rel="stylesheet" href="/atCRM/stylesheets/reports.css">


<comment>  Map-related styles  </comment>
<style>
#mapcontainer {
  position: relative;
  width: 80%;
  height: 700px;
  margin: 10px;
  float: left;
}

#map {
  width: 100%;
  height: 100%;
  border: 1px solid black;
  position: absolute;
}

#boundsLegend,#viewportLegend {
  position: absolute;
  background-color: white;
  right: 1px;
  font-family: sans-serif;
  font-size: small;
  padding: 2px;
  color: #222222;
  display: none;
}

#boundsLegend {
  border: 1px solid red;
  bottom: 40px;
}

#viewportLegend {
  border: 1px solid blue;
  bottom: 15px;
}

.info {
  border-top: 1px solid #666666;
  padding: 4px;
  padding-left: 8px;
  font: 10pt sans-serif;
  margin-left: 4px;
  margin-right: 4px;
  cursor: pointer;
  background-color: white;
}

.infoWindowContent {
  width: 272px;
  height: 120px;
  overflow: auto;
}

.tabContent {
  font: 10pt sans-serif;
  border-collapse: collapse;
  table-layout: auto;
}

#matches {
  margin-top: 10px;
  width: 320px;
  height: 490px;
  float: left;
  border: 1px solid #666666;
  display: none;
  overflow: auto;
}

h1 {
  border-bottom: 1px solid #999999;
  font-family: sans-serif;
  padding-bottom: 12px;
  width: 650px;
  margin-bottom: 0px;
}

#inputForm {
  width: 650px;
  margin: 10px;
}

#footer {
  padding-top: 4px;
  font-family: sans-serif;
  font-size: 8pt;
  clear: both;
  width: 650px;
  border-top: 1px solid #999999;
}

#instructions {
  padding-bottom: 8px;
}

.key {
  text-align: right;
  font-weight: bold;
  vertical-align: top;
  white-space: nowrap 
}

.value {
  vertical-align: top;  
}

#options {
  margin-top: 5px;
}

#newFeatures {
  position: absolute;
  top: 1px;
  right: -2px;
  background-color: #ffffd0;
  border: 1px solid black;
  font-family: sans-serif;
  font-size: 8pt;
  padding: 2px;
}
</style>

<comment>  End of map-related stuff  </comment>

<style>
#tabs-min {
	background: transparent;
	border: none;
}
#tabs-min .ui-widget-header {
	background: transparent;
	border: none;
	border-bottom: 1px solid #c0c0c0;
	-moz-border-radius: 0px;
	-webkit-border-radius: 0px;
	border-radius: 0px;
}
#tabs-min .ui-state-default {
	background: transparent;
	border: none;
}
#tabs-min .ui-state-active {
	background: transparent url(/atCRM/stylesheets/style_h/images/uiTabsArrow.png) no-repeat bottom center;
	border: none;
}
#tabs-min .ui-state-default a {
	color: #c0c0c0;
}
#tabs-min .ui-state-active a {
	color: #459E00;
}
.dataTables_wrapper {
	font-size: 9pt;
}
.blueButton {
	background-color: #4982AB;
	border-color: #D9DFEA #0E1F5B #0E1F5B #D9DFEA;
	border-style: solid;
	border-width: 1px;
	color: white;
	cursor: pointer;
	font-family: "lucida grande",tahoma,verdana,arial,sans-serif;
	font-size: 12px;
}
.flash{
	padding-top:4px;
	padding-bottom:4px;
	background-color: #FFFF33;
	font-weight:bold;
	font-size:12px;-moz-border-radius: 6px;-webkit-border-radius: 6px;
	color: black;
}
.alignRight {
	text-align: right;
}

</style>
<comment></comment>

	<script type="text/javascript" src="/atCRM/javascript/runReportJ.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/jquery-ui-1.8.21.custom.min.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/jquery.dataTables.js"></script>
	<script src="/atCRM/javascript/hc/js/highcharts.js"></script>
	<script src="/atCRM/javascript/hc/js/modules/exporting.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/funnel.src.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/pivot/accounting.min.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/pivot/subnav.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/pivot/pivot.js"></script>
	<!-- jquery_pivot must be loaded after pivot.js and jQuery -->
	<script type="text/javascript" src="/atCRM/javascript/jquery/pivot/jquery_pivot.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/pivot/dataTables.bootstrap.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/pivot/jquery.dataTables.min.js"></script>
	<!--  MUST appear AFTER all the above JS, it seems -->
	<script type="text/javascript" src="/atCRM/javascript/jquery/ZeroClipboard.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/TableTools.js"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/ColReorderWithResize.js"></script>
	<script src="/atCRM/javascript/JSON/jquery/jquery.hoverIntent.js?nv=1" type="text/javascript"></script>
	<script type="text/javascript" src="/atCRM/javascript/jquery/FixedColumns.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script src="/atCRM/javascript/JSON/smartsuggestNew.js" type="text/javascript" ></script>


<script type="text/javascript">

<comment>  Map-related JS  </comment>
var MAPFILES_URL = "http://maps.gstatic.com/intl/en_us/mapfiles/";

var map = null;
var geocoder = null;
var shadow = null;
var clickIcon = null;
var clickMarker = null;
var markers = null;
var selected = null;
var infowindow = null;
var boundsOverlay = null;
var viewportOverlay = null;
var initialized = false;
var hashFragment = "";

var GeocoderStatusDescription = {
  "OK": "The request did not encounter any errors",
  "UNKNOWN_ERROR": "A geocoding or directions request could not be successfully processed, yet the exact reason for the failure is not known",
  "OVER_QUERY_LIMIT": "The webpage has gone over the requests limit in too short a period of time",
  "REQUEST_DENIED": "The webpage is not allowed to use the geocoder for some reason",
  "INVALID_REQUEST": "This request was invalid",
  "ZERO_RESULTS": "The request did not encounter any errors but returns zero results",
  "ERROR": "There was a problem contacting the Google servers"
};

var GeocoderLocationTypeDescription = {
  "ROOFTOP": "The returned result reflects a precise geocode.",
  "RANGE_INTERPOLATED": "The returned result reflects an approximation (usually on a road) interpolated between two precise points (such as intersections). Interpolated results are generally returned when rooftop geocodes are unavilable for a street address.",
  "GEOMETRIC_CENTER": "The returned result is the geometric center of a result such a line (e.g. street) or polygon (region).",
  "APPROXIMATE": "The returned result is approximate."
}

function initMap() {
  var params = parseUrlParams();
  clearOptions();
  setOptions(params);

  var mapOptions = {
    'zoom': (params.zoom ? params.zoom : 6),
    'center': (params.center ? params.center : new google.maps.LatLng(13, 77)),
    'mapTypeId': google.maps.MapTypeId.ROADMAP,
    'scaleControl': true
  }
  map = new google.maps.Map(document.getElementById("map"), mapOptions);
  
  geocoder = new google.maps.Geocoder();
  
  infowindow = new google.maps.InfoWindow({
    'size': new google.maps.Size(292, 120)
  });
  
  shadow = new google.maps.MarkerImage(
    MAPFILES_URL + "shadow50.png",
    new google.maps.Size(37, 34),
    new google.maps.Point(0, 0),
    new google.maps.Point(10, 34)
  );
   
  clickIcon = new google.maps.MarkerImage(
    MAPFILES_URL + 'dd-start.png',
    new google.maps.Size(20, 34),
    new google.maps.Point(0, 0),
    new google.maps.Point(10, 34)
  );
    
  google.maps.event.addListener(map, 'click', onClickCallback);
  
  submitQuery();
  initialized = true;
  
  setInterval(checkHashFragment, 200);
}

function onClickCallback(event){
    document.getElementById("query").value = event.latLng.toUrlValue(6);
    geocode({ 'latLng': event.latLng });
}

function checkHashFragment() {
  if (unescape(window.location.hash) != unescape(hashFragment)) {
    var params = parseUrlParams();
    clearOptions();
    setOptions(params);
    if (params.zoom && params.center) {
      map.setZoom(params.zoom);
      map.setCenter(params.center);
      initialized = false;
    } else {
      submitQuery();
    }
  }
}

function parseUrlParams() {
  var params = {};
  
  if (window.location.search) {
    params.query = unescape(window.location.search.substring(1));
  }
  
  if (window.location.hash) {
    hashFragment = unescape(window.location.hash);
    var args = hashFragment.substring(1).split('&');
    for (var i in args) {
      var param = args[i].split('=');
      switch (param[0]) {
        case 'q':
          params.query = unescape(param[1]);
          break;
        case 'vpcenter':
          var center = parseLatLng(param[1]);
          if (center != null) {
            params.center = center;
          }
          break;
        case 'vpzoom':
          var zoom = parseInt(param[1]);
          if (! isNaN(zoom)) {
            params.zoom = zoom;
          }
          break;
        case 'country':
          params.country = unescape(param[1]);
          break;
        case 'language':
          params.language = unescape(param[1]);
          break;
      }
    }
  }
  
  return params;
}

function clearOptions() {
}

function setOptions(params) {

}
var failedAddr = "";
function submitQuery() {

  for (var i in mapTData) {
    var query = mapTData[i];
	failedAddr += query;
	query = query.substring(0,query.lastIndexOf(","));
    if (/\s*^\-?\d+(\.\d+)?\s*\,\s*\-?\d+(\.\d+)?\s*$/.test(query)) {
		var latlng = parseLatLng(query);
		if (latlng == null) {
		  document.getElementById("query").value = "";
		} else {
		  geocode({ 'latLng': latlng });
		}
	  } else {
		geocode({ 'address': query });
	}
  }
}

function geocode(request) {  
  resetMap();
  var hash = '';
  
  if (request.latLng) {
    clickMarker = new google.maps.Marker({
      'position': request.latLng,
      'map': map,
      'title': request.latLng.toString(),
      'clickable': false,
      'icon': clickIcon,
      'shadow': shadow
    });
    hash = 'q=' + request.latLng.toUrlValue(6);
  } else {
    hash = 'q=' + request.address;
  }
  
  hashFragment = '#' + escape(hash);
  window.location.hash = escape(hash);
  geocoder.geocode(request, showResults);
}

function parseLatLng(value) {
  value.replace('/\s//g');
  var coords = value.split(',');
  var lat = parseFloat(coords[0]);
  var lng = parseFloat(coords[1]);
  if (isNaN(lat) || isNaN(lng)) {
    return null;
  } else {
    return new google.maps.LatLng(lat, lng);
  }
}

function resetMap() {
  infowindow.close();

  if (clickMarker != null) {
    clickMarker.setMap(null);
    clickMarker = null;
  }
  
  for (var i in markers) {
    markers[i].setMap(null);
  }
  
  markers = [];
  selected = null;
  clearBoundsOverlays();
}

function showResults(results, status) {
  var reverse = (clickMarker != null);
  
  if (! results) {failedAddr += ",";//alert('Address -- '+failedAddr);
	//document.getElementById("recNotPlotDiv").innerHTML += "\n"+failedAddr;
    //alert("Geocoder did not return a valid response");
  } else {
		failedAddr = failedAddr.substring(0,failedAddr.lastIndexOf(",")+1);
		plotMatchesOnMap(results, reverse);
  }
}

function plotMatchesOnMap(results, reverse) {
  
  markers = new Array(results.length);
  var resultsListHtml = "";
  
  var openInfoWindow = function(resultNum, result, marker) {
    return function() {
      if (selected != null) {
        clearBoundsOverlays();
      }
      
      //map.fitBounds(result.geometry.viewport);
      infowindow.setContent(getAddressComponentsHtml(result.address_components));
      infowindow.open(map, marker);

      if (result.geometry.bounds) {
        boundsOverlay = new google.maps.Rectangle({
          'bounds': result.geometry.bounds,
          'strokeColor': '#ff0000',
          'strokeOpacity': 1.0,
          'strokeWeight': 2.0,
          'fillOpacity': 0.0
        });
        boundsOverlay.setMap(map);
        google.maps.event.addListener(boundsOverlay, 'click', onClickCallback);
      } else {
        boundsOverlay = null;
      }
      
      viewportOverlay = new google.maps.Rectangle({
          'bounds': result.geometry.viewport,
          'strokeColor': '#0000ff',
          'strokeOpacity': 1.0,
          'strokeWeight': 2.0,
          'fillOpacity': 0.0
        });
      viewportOverlay.setMap(map);
      google.maps.event.addListener(viewportOverlay, 'click', onClickCallback);

      selected = resultNum;
    }
  }
    
  for (var i = 0; i < results.length; i++) {
    var icon = new google.maps.MarkerImage(
      getMarkerImageUrl(i),
      new google.maps.Size(20, 34),
      new google.maps.Point(0, 0),
      new google.maps.Point(10, 34)
    );
    
    markers[i] = new google.maps.Marker({
      'position': results[i].geometry.location,
      'map': map,
      'icon': icon,
      'shadow': shadow
    });

    google.maps.event.addListener(markers[i], 'click', openInfoWindow(i, results[i], markers[i]));
    resultsListHtml += getResultsListItem(i, getResultDescription(results[i]));
  }

}

function selectMarker(n) {
  google.maps.event.trigger(markers[n], 'click');
}

function zoomToViewports(results) {
  var bounds = new google.maps.LatLngBounds();

  for (var i in results) {
    bounds.union(results[i].geometry.viewport);
  }

  map.fitBounds(bounds);
}

function getMarkerImageUrl(resultNum) {
  //return MAPFILES_URL + "marker" + String.fromCharCode(65 + resultNum) + ".png";
  return MAPFILES_URL + "marker.png";
}

function getResultsListItem(resultNum, resultDescription) {
  var html  = '<a onclick="selectMarker(' + resultNum + ')">';
      html += '<div class="info" id="p' + resultNum + '">';
      html += '<table><tr valign="top">';
      html += '<td style="padding: 2px"><img src="' + getMarkerImageUrl(resultNum) + '"/></td>';
      html += '<td style="padding: 2px">' + resultDescription + '</td>';
      html += '</tr></table>';
      html += '</div></a>';
  return html;
}

function getResultDescription(result) {
  var bounds = result.geometry.bounds;
  var html  = '<table class="tabContent">';
      html += tr('Address', result.formatted_address);

      html += tr('Types', result.types.join(", "));
      html += tr('Location', result.geometry.location.toString());
      html += tr('Bounds', (bounds ? boundsToHtml(bounds) : "None"));
      html += tr('Viewport', boundsToHtml(result.geometry.viewport));
      html += tr('Location type', result.geometry.location_type);
      if (result.partial_match) {
        html += tr('Partial match', 'Yes');
      }
      html += '</table>';
  return html;
}

function getAddressComponentsHtml(components) {
  var html = '<div class="infoWindowContent">' +
               '<table class="tabContent">';
               
  for (var i = 0; i < components.length; i++) {    
    html += tr("Long name", components[i].long_name);
    html += tr("Short name", components[i].short_name);
    html += tr("Types", components[i].types[0]);
    for (var j = 1; j < components[i].types.length; j++) {
      html += tr("", components[i].types[j]);
    }
    if (i < components.length-1) {
      html += br();
    }
  }
  
  html += '</table></div>';
  return html;
}

function tr(key, value) {
  return '<tr>' +
           '<td class="key">' + key + (key ? ':' : '') + '</td>' +
           '<td class="value">' + value + '</td>' +
         '</tr>';
}

function br() {
  return '<tr><td colspan="2"><div style="width: 100%; border-bottom: 1px solid grey; margin: 2px;"</td></tr>';
}

function clearBoundsOverlays() {
  if (boundsOverlay != null) {
    boundsOverlay.setMap(null);
  }
  if (viewportOverlay != null) {
    viewportOverlay.setMap(null);
  }
}

function boundsToHtml(bounds) {
  return '(' +
    bounds.getSouthWest().toUrlValue(6) +
    ') -<br/>(' +
    bounds.getNorthEast().toUrlValue(6) +
    ')';
}

<comment>  End of Map-related JS  </comment>

<comment>  If no-data case, do nothing  </comment>
<if !stringLib.index (runReport.report.runResult.escapedString, "var dataTblData = [ ]")>

	/*  Variables to carry pivot and chart selections, to write into db */
	var piv_str;
	var last_piv_upd = '';
	var init_piv_obj;
	var last_cht_upd = '';

<comment> other_str carries options for display: tab to open (0,1,2 - Data, Chart, Pivot), if message to be shown (0 or 1),
			data display collapsed or not
</comment>
<if runReport.report.tabEtc>
	var other_str_opt = ${runReport.report.tabEtc};
	var other_str = '${runReport.report.tabEtc}';
<else>
	var other_str_opt = [0,0];
	var other_str = '[0,0]';
</if>

	var cht_str = '${runReport.report.char_str_01}';
	var cht_arr = cht_str.split(',');
	function remEtc(s){ 
	  var st = s.replace("\"","\\\"");
	  st = st.replace(/[\n\r\t]/g," "); 
	  return(escape(st));
	}

	function getSersType(value) {
		var ret_val = '';
		ret_val = cht_arr[value - 1];
		return(ret_val);
	}

	function changeType(chart, newType, chgItem) {
	   var serie;
	   var chgSer = chgItem;
	   var currType = "";
	   
	   for(var i = 0; i < chart.series.length; i++)
	   {
	   serie = chart.series[i];
	   if (newType != 'none') {
		   i == chgSer ? currType = newType : currType = serie.type;

		   chart.addSeries({
			  type: currType,
			  name: serie.name,
			  data: serie.options.data
		   }, false);
		   
		   serie.remove(false);
	   }
	   }
	   
	   chart.redraw();
	}

	var example = 'line-basic',
		theme = 'default';
	function setupPivot(input){
		input.callbacks = {afterUpdateResults: function(){
		  $('#res_table').dataTable({
			"iDisplayLength": 50,
			"aLengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
			"bRetrieve": true,
			"oLanguage": {
			  "sLengthMenu": "_MENU_ records per page"
			}
		  });
		}};
		$('.stop-propagation').click(function(event){event.stopPropagation();});
		$('#pivot-menu-container').pivot_display('setup', input);
	};


	function submitXLForm () {
		document.forms['xlForm'].elements['rD'].value = $('#pivot-table').text();
		document.forms['xlForm'].elements['rd1'].value = $('#pivot-table').text();
		document.forms['xlForm'].elements['rN'].value = '${runReport.report.name}';
		document.forms['xlForm'].elements['tableData'].value =$('#results').html();
		document.forms['xlForm'].submit();
	}

	var date_format="dd/MM/yyyy";
	var zcServletPrefix = "${servlet_prefix}";

	var entName = "${runReport.report.entityName}";

	<comment>  The actual response from the UDM  </comment>
	${runReport.report.runResult.escapedString}

</if>
<comment>  Above END IF handles no-data case also  </comment>

	<comment>  document.ready - where it all happens  </comment>
		$(document).ready(function() {

<comment>  If no-data case, do nothing in JS  </comment>
<if !stringLib.index (runReport.report.runResult.escapedString, "var dataTblData = [ ]")>

	<comment>  Set up the tabs for Data, Chart and Pivot  </comment>
			$('#tabs-min').tabs({
				select: function(event, ui) {
					other_str = '[' + ui.index + ',0]'; 
					$.post("/atCRM/custom/adhocReports/updRepStrs/editAction", {id: '${runReport.report.report_id}', s1: cht_str, s2: piv_str, s3: other_str });
					<comment>  For some weird reason, table is rendered badly if the default tab is not the Data tab; so reset it  </comment>
					if (ui.index == 0) {
						$(".dataTable").css("width","100%");
						$(".dataTables_scrollHeadInner").css("width","100%");
					} else if (ui.index == 3) {
						if ('undefined' == typeof mapTData) {
							document.getElementById('mapDiv').innerHTML = 'No map-related data was selected in your report. Please include columns like locations, cities, etc. to enanble this tab.'
						} else {
							initMap();
						}
					}
				}
			});


			<if runReport.report.char_str_03>
				var sel_array = new Array();
				sel_array = ${runReport.report.char_str_03};
				$('#tabs-min').tabs( "select" , sel_array[0]);
			<else>
				$('#tabs-min').tabs( "select" , 0);
			</if>

	<comment>  Set up the datatable that carries tabular data  </comment>
			var json_str = JSON.stringify(dataTblData);
			var prevRow;
			var currRowArr = new Array();
			var currRowClassName;
			var oTable = $('#reportData').dataTable({
				"aaData": dataTblData,
				"aoColumns": dataTblHdr,
				"bPaginate": false,
				"bLengthChange": false,
				"sScrollX": "100%",
				"bProcessing": true,
				"bStateSave": true,
				"sDom": "\"<clear>\"RlfrTtip",
				"oTableTools": {
					"sSwfPath": "/atCRM/javascript/jquery/swf/copy_csv_xls_pdf.swf"
				},
				"aoColumnDefs": [{
						"fnRender": function ( o, val ) {
							if (!isNaN(parseFloat(val)) && isFinite(val)) {
								var parts=val.toString().split(".");
								return parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",") + (parts[1] ? "." + parts[1] : "");
							} else {
								return val;
							}
						},
						"sClass": "alignRight",
						"aTargets": aoColD_targets
				}]
			<if runReport.report.origLayoutType == "Collapsed">
				,
				"fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
					if (iDisplayIndex > 0) {
						for (var i = 0; i < nRow.cells.length; i++) {
							if (nRow.cells[i].innerHTML == currRowArr[i]) {
								if (i == 0 || nRow.cells[i - 1].innerHTML == "") {
									currRowArr[i] = nRow.cells[i].innerHTML;
									nRow.cells[i].innerHTML = "";
//								nRow.className = currRowClassName;
								} else {
									currRowArr[i] = nRow.cells[i].innerHTML;
								}
							} else {
								currRowArr[i] = nRow.cells[i].innerHTML;
								currRowClassName = nRow.className;
							}
						}
					} else {
						for (var i = 0; i < nRow.cells.length; i++) {
							currRowArr[i] = nRow.cells[i].innerHTML;
						}
						currRowClassName = nRow.className;
					}
				}
			</if>
			});

	<comment>  Set up the chart </comment>
			onScrChart = new Highcharts.Chart(adHchart);

	<comment>  Set up the pivot table </comment>

	<comment>  If there's a prior definition of pivot options, apply them  </comment>
			<if runReport.report.char_str_02 == "">
				setupPivot({json:pivot_json, fields:pivot_fields});
			<else>
				setupPivot({json:pivot_json, fields:pivot_fields,${runReport.report.char_str_02}});
			</if>
			init_piv_obj = pivot.config(true);

	<comment>  Recreate string of pivot options every time data changes  </comment>
			var piv_changed = document.getElementById("pivot-menu-container");
			piv_changed.addEventListener("DOMAttrModified", function(){
				var curr_date = new Date();
				if (last_piv_upd != '') {
					var piv_obj = pivot.config(true);
					var piv_past_str = piv_str;
					seen = [];
					piv_str = JSON.stringify(piv_obj, function(key, val) {
					   if (typeof val == "object") {
							if (seen.indexOf(val) >= 0)
								return undefined;
							seen.push(val);
						}
						return val;
					});

					if (piv_past_str != piv_str)
					{
						piv_str = piv_str.slice(1, piv_str.length - 1);
						$.post("/atCRM/custom/adhocReports/updRepStrs/editAction", { id: '${runReport.report.report_id}', s1: cht_str, s2: piv_str, s3: other_str } );
					}
				} else {
					last_piv_upd = curr_date;
				}

			});

			<if runReport.report.origLayoutType == "Collapsed">
				$(".DTTT_container").append("<span style=\"vertical-align:middle\">&nbsp;&nbsp;&nbsp;&nbsp;<i>Data has been collapsed.</i></span>");
			</if>


	<comment>  Flash message if needed  
			<assign hasComma = stringLib.index (runReport.report.tabEtc, ",")>
			<if hasComma>
				<if integerLib.compare (hasComma,">",0)>
					setTimeout(function(){
					  $(".flash").fadeOut("slow", function () {
					  $(".flash").remove();
					}); }, 4000);
					if (other_str_opt[1] == '1') {
						document.getElementById('flash_mesg').innerHTML = 'The Ad Hoc Reporting Engine has been upgraded. Please re-select your Pivot columns.';
						$('#tabs-min').tabs( "select" , 2);
					}
				</if>
			</if>
			</comment>
		</if>
<comment>  Above END IF handles no-data case also  </comment>

	<!-- below javascript is for report menu slide down -->
			function show() {
				var menu = $(this);
				menu.children(".actions").slideDown();
			}
			
			function hide() { 
				var menu = $(this);
				menu.children(".actions").slideUp();
			}
			
			$(".hover-menu").hoverIntent({
				sensitivity: 1, // number = sensitivity threshold (must be 1 or higher)
				interval: 50,   // number = milliseconds for onMouseOver polling interval
				over: show,     // function = onMouseOver callback (required)
				timeout: 300,   // number = milliseconds delay before onMouseOut
				out: hide       // function = onMouseOut callback (required)
			});
	
<comment>  If you need more document.ready functions, add them below here  </comment>

<comment>  If you need more document.ready functions, add them above here  </comment>
		});
<comment>  End of document.ready function   </comment>

//this function is called from eDash.html
function calleDashfns()
{
	try
	{
		parent.hideLoadingPreview();
		var reportHeader=document.getElementsByClassName('reportElementHeader');
		reportHeader[0].style.display="none";		
	}
	catch (e)
	{
	}
}

function linkContactsWithMktgPrgm(){
	document.getElementById("mktgPgm").innerHTML = "";
		$("#mktgPgm").dialog({
			closeOnEscape:true,
			autoOpen:true,
			modal: true,
			title:'Add all these contacts to a Campaign',
			minHeight:120,
		    minWidth:120,	
		    width:300,
			draggable:false
		});		
		var convertDivContent = "<table style='margin-top:5px; border:0px solid red;' cellpadding='3' width='280px'>";
		convertDivContent+="<tr><td align='center'><div style='border:0px solid red; margin-top:20px;text-align:center;'><font><b>Select existing Campaign</b></font><br/><font style='text-align:center;font-size:10px;color:#999999'>All contacts will be added to this campaign.</font><br /><input type='text'  value='2 chars or *' onfocus='javascript:clearVal(this.id);' style='margin-left:16px;margin-top:5px' onkeyup=\"javascript:listMarketingProgram('autosuggestUsers',this.id,event.keyCode,this.value)\"  onblur=\"javascript:replaceVal(this.value,this.id);\"  id='mktListtxt' name='mktListtxt' size='30'><input type='hidden' name='mktList' id='mktList' size='25' value=''><input type='hidden' name='existname' id='existname' size='25' value=''></div><input style='width:80px;margin-top:15px;margin-left:40px;' class='greenButton' type='button' value='Copy contacts' onclick=\"javascript:checkMktgProgram();\" id='contactlistbutton' name='contactlistbutton'></td></tr>"
		convertDivContent += "</table>";
		document.getElementById("mktgPgm").innerHTML = convertDivContent;	
	
}
function checkMktgProgram(){
	var contactElements = '';
	var url = '';
	var mktgId = document.getElementById('mktList').value;
	var mktgName = document.getElementById('mktListtxt').value;
	
//	alert(mktgId);
//	alert(internId.length);

	if (mktgId!='' && internId!='')
	{	
		$.ajax({
				type: "POST",
				data: "mktgId="+mktgId+"&contCSV="+internId,
				url: "${servlet_prefix}/custom/marketing/linkContactsToMktgProgm.html",
				dataType: "html",				
				success: function (doc)
				{	
					var contCount = internId.length;		
					var convertDivContent = "<table align='center' border='0' style='margin-top:5px' cellpadding='3'>";
					convertDivContent += "<tr><td class='Default'><br/><br/><b>"+contCount+"</b> contacts added to <b>"+mktgName+"</b> campaign.<br/><br/></td></tr>"; 
					convertDivContent += "</table>";
					document.getElementById("mktgPgm").innerHTML = convertDivContent;
					setTimeout("closemktgalert()",1000);
				},
				error: function() 
				{
					var convertDivContent = "<table align='center' style='margin-top:5px' cellpadding='3'>";
					convertDivContent += "<tr><td colspan='2' style='text-align:center'><br/><br/>Contacts are not added to Campaign. Please try again.<br/><br/></td></tr>"; 
					convertDivContent += "</table></center><br/>";
					document.getElementById("mktgPgm").innerHTML = convertDivContent;
					setTimeout("closemktgalert()",1000);
				}
				});	
	}

}
function listMarketingProgram(divName,txtId,key,val)
{

	if(key==13)
	{
		return false;
	}
	else if(val.length>=1)
		{
			$.ajax({
			type: "GET",
			url: "${servlet_prefix}/custom/CallCenter/listMarketingProgram.xml?str="+val,
			dataType: "xml",
			success: function (doc)
			{
				var MarketingProgram = doc.getElementsByTagName("MarketingProgram");
				var marketingProgramName=MarketingProgram[0]?MarketingProgram[0].getAttribute("marketingProgramName") : null;
				var temp = new Array();
				temp = marketingProgramName.split('~)');
				new AutoSuggest(divName,document.getElementById(txtId),temp);
				}
			});
		}
}
</script>

	</head>
	<body onload="calleDashfns();">
		<div class="reportElementHeader">
			<table cellpadding="0" cellspacing="0" width="100%" border="0" style="vertical-align: middle;">
				<tr>
					<td width="90%">
						<span class="pageheader">${runReport.report.name}</span><span style="color: white;">&nbsp;${runReport.reportCreatedBy.created_by__deref.derefValue} at ${runReport.timeNow}</span>
					</td>
					<td>
						<div class="hover-menu" classname="hover-menu" id="runreport-menu" name="runreport-menu" style="width: 100px; position: relative; display: block;">Report Menu
						<ul class="actions no-style" classname="actions no-style" style="position: absolute; display: none;">
							<li title="Edit Report" onClick="window.location.href='editReport.html?reportId=${runReport.report.report_id}'"><a href="javascript:void(0)">Edit Report</a></li>
							<li title="Print Report" onClick="window.print()"><a href="javascript:void(0)">Print Report</a></li>
							<li title="EOD Alert" onClick="javascript:getEODAlert();"><a href="javascript:void(0)">EOD Alert</a></li>
							<li title="Add to Campaign" onClick="javascript:linkContactsWithMktgPrgm();"><a href="javascript:void(0)">Add to Campaign</a></li>
							<li title="Generate Coupons" onClick="javascript:linkContactsWithCouponPlan();"><a href="javascript:void(0)">Generate Coupons</a></li>
						</ul>
						</div>
					</td>  	
				</tr>
			</table>
<comment>
			<assign firstCommaInOpt = stringLib.index (runReport.report.tabEtc, ",") + 1>
			<assign charAftFirstCommaInOpt = firstCommaInOpt + 1>
			<if integerLib.compare (stringLib.substring (runReport.report.tabEtc,firstCommaInOpt,charAftFirstCommaInOpt),"<","0")><div class='flash' id='flash_mesg'></div></if>
</comment>
			</div>

<comment>  If no-data case, do nothing  </comment>
<if !stringLib.index (runReport.report.runResult.escapedString, "var dataTblData = [ ]")>
		<assign cht_sels = stringLib.split (runReport.report.char_str_01, ",")>

		<div id="tabs-2">
			<div id="tabs-min" class="tabs ui-tabs ui-widget ui-widget-content ui-corner-all">
				  <ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">     
					 <li class="ui-tabs-selected ui-state-active"><a href="#tabData">Data</a></li>
					 <li><a href="#tabChart">Chart</a></li>
					 <li><a href="#tabPivot">Pivot</a></li>
					 <li><a href="#tabMap">Map</a></li>
				  </ul>
				<div id="tabData">
					<table id="reportData"></table>
				</div>
				<div id="tabChart">
					<div align="center" style="font-size:9pt;">
						<p align="left">You can select the type of chart that you'd like to see for each set of data here. Please note: only the first 25 items in your report are charted.<br></p>
						<assign series_idx = 0>
						<list runReport.report.query.attributes as attr>
							<assign idx1 = idx1 + 1>
							<if attr.attributeProps.dataType != "Number" || attr.description == "internalId">
							<else>
								${attr.description}: <select id="s_${attr.attributeProps.columnName}" name="s_${attr.attributeProps.columnName}" onchange="chg_${attr.attributeProps.columnName}()" style="font-family:"Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif;"><option <if cht_sels[series_idx] == "column">selected="selected"</if> value="column">Column</option><option <if cht_sels[series_idx] == "funnel">selected="selected"</if> value="funnel">Funnel</option><option <if cht_sels[series_idx] == "line">selected="selected"</if> value="line">Line</option><option <if cht_sels[series_idx] == "pie">selected="selected"</if> value="pie">Pie</option>
								</select>
								<script>
									function chg_${attr.attributeProps.columnName}(){
										var cmb_val = (document.getElementById("s_${attr.attributeProps.columnName}").value) ? document.getElementById("s_${attr.attributeProps.columnName}").value : "line";
										changeType(onScrChart, cmb_val, ${series_idx});
										cht_arr [${series_idx}] = cmb_val;
										cht_str = cht_arr.toString();
										$.post("/atCRM/custom/adhocReports/updRepStrs/editAction", { id: '${runReport.report.report_id}', s1: cht_str, s2: piv_str, s3: other_str } );
									}
								</script>
								<assign series_idx = series_idx + 1>
							</if>
						</list>
					</div>
					<div id="chartContainer" style="min-width: 95%; height: 400px; margin: 0 auto"></div>
				</div>
				<div id="tabPivot">
					<div id="pivot-menu-container">
						<table width="100%"><tr><td width="90%">Please select the appropriate columns below to create your own Pivot Report.</td><td><button id='expxlb'>Export</button></td></tr></table>

						<div class="subnav">
							  <ul class="nav nav-pills">
								<li class="dropdown">
								  <a class="dropdown-toggle" data-toggle="dropdown" href="#">
									Row Headers
									<b class="caret"></b>
								  </a>
								  <ul class="dropdown-menu stop-propagation" style="overflow:auto;max-height:450px;padding:10px;">
									<div id="row-label-fields"></div>
								  </ul>
								</li>
								<li class="dropdown">
								  <a class="dropdown-toggle" data-toggle="dropdown" href="#">
									Column Headers
									<b class="caret"></b>
								  </a>
								  <ul class="dropdown-menu stop-propagation" style="overflow:auto;max-height:450px;padding:10px;">
									<div id="column-label-fields"></div>
								  </ul>
								</li>
								<li class="dropdown">
								  <a class="dropdown-toggle" data-toggle="dropdown" href="#">
									Summary Fields
									<b class="caret"></b>
								  </a>
								  <ul class="dropdown-menu stop-propagation" style="overflow:auto;max-height:450px;padding:10px;">
									<div id="summary-fields"></div>
								  </ul>
								</li>
								<li class="dropdown">
								  <a class="dropdown-toggle" data-toggle="dropdown" href="#">
									Filters
									<b class="caret"></b>
								  </a>
								  <ul class="dropdown-menu stop-propagation" style="overflow:auto;max-height:450px;padding:10px;">
									<div id="filter-list"></div>
								  </ul>
								</li>
							  </ul>
						</div>
					</div>
					<div id="results"><table id="res_table"><tr><td></td></tr></table></div>
				</div>
				<div id="tabMap">
					<div id="mapDiv">
						<div id="mapcontainer">
						  <div id="map"></div>
						</div><!-- <div id="recNotPlotDiv" style="display: block;">Below are the Addresses that Google does not recognise:</div> -->
					</div>
				</div>
			</div>
		</div>

		<div id="autosuggestUsers" name='autosuggestUsers' style='display:none;position: absolute;z-index: 2147483647;'></div>
		<div id="mktgPgm"></div>
		<div id="couponPlan"></div>
		<div id="previewEmail"></div>
		<div id="previewPrint"></div>
		<div id="previewSms"></div>
		<div id="eodpopup" title="EOD Alert" style="display:none;min-height:380px;">   
			<iframe name="eodalertpopup" id="eodalertpopup" valign="top" frameborder="0" width="100%" height="380px" src="${servlet_prefix}/custom/adhocReports/eodAlert.html?reportId=${runReport.report.report_id}"></iframe>    
			<div id="msg" style="display:none;text-align:center;vertical-align:middle;font-weight:bold; margin-top:30px;"></div>       
		</div>
<else>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;No data for report.
</if>
<comment>  Above END IF for no-data case  </comment>

<comment>  For submission to get XL format  </comment>
      <form name="xlForm" id="xlForm" style="display: none" method="post" action="${servlet_prefix}/custom/adhocReports/rXL.xls">
        <textarea name="rD" id="rD" style="display: none"></textarea>
        <textarea name="rN" id="rN" style="display: none"></textarea>
        <textarea name="tableData" id="tableData" style="display: none"></textarea>
		<input type="text" name="rd1" style="display: none"/>
      </form>

<script>

 $('#expxlb').click(function() {
  submitXLForm();
});

 </script>
</body>
</html>
